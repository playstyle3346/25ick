// lib/services/movie_algorithm.dart

class MovieAlgorithm {
  /// =========================================================
  /// 1) 포스터 파일 경로
  /// =========================================================
  static Map<String, String> posterPaths = {
    "라라랜드": "assets/posters/lalaland.jpg",
    "어벤져스: 엔드게임": "assets/posters/avengers.jpg",
    "인사이드 아웃": "assets/posters/insideout.jpg",
    "겟 아웃": "assets/posters/getout.jpg",
    "포레스트 검프": "assets/posters/forrestgump.jpg",
    "기생충": "assets/posters/parasite.jpg",
    "인터스텔라": "assets/posters/interstellar.jpg",
    "위플래시": "assets/posters/whiplash.jpg",
    "겨울왕국": "assets/posters/frozen.jpg",
    "부산행": "assets/posters/train_to_busan.jpg",
  };

  /// =========================================================
  /// 2) 영화 → 태그
  /// =========================================================
  static Map<String, List<String>> movieTags = {
    "라라랜드": ["로맨스", "감성", "뮤직"],
    "어벤져스: 엔드게임": ["액션", "히어로"],
    "인사이드 아웃": ["애니메이션", "감성"],
    "겟 아웃": ["공포", "스릴러"],
    "포레스트 검프": ["드라마", "감성"],
    "기생충": ["스릴러", "범죄", "드라마"],
    "인터스텔라": ["SF", "드라마"],
    "위플래시": ["드라마"],
    "겨울왕국": ["애니메이션", "뮤지컬", "판타지"],
    "부산행": ["스릴러", "좀비", "액션"],
  };

  /// =========================================================
  /// 3) 유형 → 핵심 태그 (유형 점수 계산용)
  /// =========================================================
  static Map<String, List<String>> typeCoreTags = {
    "감성 로맨스 Lover": ["로맨스", "감성", "뮤직"],
    "액션·히어로 파워형": ["액션", "히어로"],
    "애니메이션·동심 감성파": ["애니메이션", "판타지", "뮤지컬"],
    "공포·스릴러 헌터": ["공포", "스릴러"],
    "휴먼 드라마 Enthusiast": ["드라마", "감성"],
    "범죄·블랙미스터리 마니아": ["범죄", "스릴러"],
    "SF·우주 탐험가": ["SF"],
    "좀비·생존 액션러": ["좀비", "액션"],
    "다양성 취향 균형형": [],
  };

  /// =========================================================
  /// 4) 유형별 추천 영화
  /// =========================================================
  static Map<String, List<String>> recommendations = {
    "감성 로맨스 Lover": ["라라랜드", "노팅힐", "비포 선라이즈"],
    "액션·히어로 파워형": ["어벤져스: 엔드게임", "매드맥스: 분노의 도로", "다크 나이트"],
    "애니메이션·동심 감성파": ["인사이드 아웃", "코코", "겨울왕국 2"],
    "공포·스릴러 헌터": ["겟 아웃", "유전", "나이트크롤러"],
    "휴먼 드라마 Enthusiast": [
      "포레스트 검프",
      "더 퍼스트 슬램덩크",
      "인생은 아름다워"
    ],
    "범죄·블랙미스터리 마니아": ["기생충", "나이브스 아웃", "세븐"],
    "SF·우주 탐험가": ["인터스텔라", "그래비티", "매트릭스"],
    "좀비·생존 액션러": ["부산행", "28일 후", "킹덤"],
    "다양성 취향 균형형": ["기생충", "인사이드 아웃", "위플래시"],
  };

  /// =========================================================
  /// 5) 유형별 키워드
  /// =========================================================
  static Map<String, List<String>> typeKeywords = {
    "감성 로맨스 Lover": ["감성 강한 타입", "스토리 중요", "연출·음악 중시", "몰입형 관객"],
    "액션·히어로 파워형": ["스케일 중시", "속도감 중요", "히어로물 선호", "타격감·쾌감형"],
    "애니메이션·동심 감성파": [
      "동심형 감성",
      "비주얼 중시",
      "따뜻한 관계",
      "가볍고 편안함"
    ],
    "공포·스릴러 헌터": ["긴장감 선호", "반전·추리형", "어두운 분위기", "빠른 몰입"],
    "휴먼 드라마 Enthusiast": [
      "인물 중심",
      "감정선 중요",
      "잔잔한 여운",
      "현실적 서사"
    ],
    "범죄·블랙미스터리 마니아": [
      "사건 중심",
      "심리묘사 선호",
      "도덕적 모호성",
      "미스터리 중시"
    ],
    "SF·우주 탐험가": ["세계관 중시", "철학적 질문", "비주얼 임팩트", "몰입감 높은 관객"],
    "좀비·생존 액션러": ["긴박함 선호", "생존 서사", "강한 몰입감", "분위기·연출 중시"],
    "다양성 취향 균형형": [
      "장르 편식 없음",
      "균형 잡힌 취향",
      "새로운 것 선호",
      "유연한 관객"
    ],
  };

  /// =========================================================
  /// 6) 내부 상태
  /// =========================================================
  static Map<String, int> tagScore = {}; // 태그 점수 누적
  static String lastUserType = ""; // 최종 유저 유형
  static List<String> lastRecommendations = []; // 결과 화면용 추천 리스트 (최소 1개)
  static String lastWinningMovie = ""; // 토너먼트 최종 우승 영화

  static void reset() {
    tagScore = {};
    lastUserType = "";
    lastRecommendations = [];
    lastWinningMovie = "";
  }

  /// =========================================================
  /// 7) 선택 영화 → 태그 점수 누적
  /// =========================================================
  static void addScore(String movie) {
    final tags = movieTags[movie];
    if (tags == null) return;

    for (final tag in tags) {
      tagScore[tag] = (tagScore[tag] ?? 0) + 1;
    }
  }

  /// =========================================================
  /// 8) 🔥 점수 기반 자동 유저 타입 분류 (동점 해결)
  /// =========================================================
  static String determineUserType() {
    if (tagScore.isEmpty) return "다양성 취향 균형형";

    Map<String, int> typePoints = {};

    // 유형별 핵심 태그 점수 합산
    typeCoreTags.forEach((type, tags) {
      int score = 0;
      for (final t in tags) {
        score += (tagScore[t] ?? 0);
      }
      typePoints[type] = score;
    });

    // 최댓값 유형 찾기
    final best = typePoints.entries.reduce((a, b) {
      return a.value >= b.value ? a : b;
    });

    // 모든 유형 점수가 0이면 균형형
    if (best.value == 0) {
      return "다양성 취향 균형형";
    }

    return best.key;
  }

  /// =========================================================
  /// 9) 🔥 토너먼트 최종 결과 정리
  ///    - mainMovie: 토너먼트에서 마지막으로 살아남은 영화
  ///    - lastUserType, lastRecommendations까지 모두 세팅
  /// =========================================================
  static void finalizeResult(String mainMovie) {
    lastWinningMovie = mainMovie;

    // 1) 유저 유형 계산
    final type = determineUserType();
    lastUserType = type;

    // 2) 추천 리스트 구성
    //    - 1순위: 토너먼트 우승 영화
    //    - 2~3순위: 유형별 추천 영화 중에서 우승 영화와 겹치지 않는 것
    final baseRecs = recommendations[type] ?? [];
    final List<String> finalRecs = [];

    // 메인 영화는 무조건 첫 번째
    finalRecs.add(mainMovie);

    for (final m in baseRecs) {
      if (m != mainMovie && finalRecs.length < 3) {
        finalRecs.add(m);
      }
    }

    // 그래도 3개가 안 되면 포스터에 등록된 다른 영화로 채우기
    if (finalRecs.length < 3) {
      for (final m in posterPaths.keys) {
        if (!finalRecs.contains(m)) {
          finalRecs.add(m);
          if (finalRecs.length >= 3) break;
        }
      }
    }

    lastRecommendations = finalRecs;
  }
}

// class MovieAlgorithm {
//   /// =========================================================
//   /// 1) 포스터 파일 경로 매핑
//   /// =========================================================
//   static Map<String, String> posterPaths = {
//     "라라랜드": "assets/posters/lalaland.jpg",
//     "어벤져스: 엔드게임": "assets/posters/avengers.jpg",
//     "인사이드 아웃": "assets/posters/insideout.jpg",
//     "겟 아웃": "assets/posters/getout.jpg",
//     "포레스트 검프": "assets/posters/forrestgump.jpg",
//     "기생충": "assets/posters/parasite.jpg",
//     "인터스텔라": "assets/posters/interstellar.jpg",
//     "위플래시": "assets/posters/whiplash.jpg",
//     "겨울왕국": "assets/posters/frozen.jpg",
//     "부산행": "assets/posters/train_to_busan.jpg",
//   };
//
//   /// =========================================================
//   /// 2) 장르 태그 매핑
//   /// =========================================================
//   static Map<String, List<String>> movieTags = {
//     "라라랜드": ["로맨스", "감성", "뮤직"],
//     "어벤져스: 엔드게임": ["액션", "히어로"],
//     "인사이드 아웃": ["애니메이션", "감성"],
//     "겟 아웃": ["공포", "스릴러"],
//     "포레스트 검프": ["드라마", "감성"],
//     "기생충": ["스릴러", "범죄", "드라마"],
//     "인터스텔라": ["SF", "드라마"],
//     "위플래시": ["드라마"],
//     "겨울왕국": ["애니메이션", "뮤지컬", "판타지"],
//     "부산행": ["스릴러", "좀비", "액션"],
//   };
//
//   /// =========================================================
//   /// 3) 점수 저장소 및 최종 결과 저장 변수
//   /// =========================================================
//   static Map<String, int> tagScore = {};
//   static String lastUserType = "";
//   static List<String> lastRecommendations = [];
//
//   static void reset() {
//     tagScore = {};
//     lastUserType = "";
//     lastRecommendations = [];
//   }
//
//   /// =========================================================
//   /// 4) 영화 선택 시 점수 추가
//   /// =========================================================
//   static void addScore(String movie) {
//     final tags = movieTags[movie];
//     if (tags == null) return;
//
//     for (final tag in tags) {
//       tagScore[tag] = (tagScore[tag] ?? 0) + 1;
//     }
//   }
//
//   /// =========================================================
//   /// 5) 사용자 유형 분석
//   /// =========================================================
//   static String determineUserType() {
//     final s = tagScore;
//
//     int romance = (s["로맨스"] ?? 0) + (s["감성"] ?? 0) + (s["뮤직"] ?? 0);
//     int action = (s["액션"] ?? 0) + (s["히어로"] ?? 0);
//     int animation = (s["애니메이션"] ?? 0) + (s["판타지"] ?? 0) + (s["뮤지컬"] ?? 0);
//     int thriller = (s["스릴러"] ?? 0) + (s["공포"] ?? 0);
//     int drama = (s["드라마"] ?? 0) + (s["감성"] ?? 0);
//     int crime = (s["범죄"] ?? 0);
//     int sf = (s["SF"] ?? 0);
//     int zombie = (s["좀비"] ?? 0);
//
//     if (romance >= 2) return "감성 로맨스 Lover";
//     if (action >= 2) return "액션·히어로 파워형";
//     if (animation >= 2) return "애니메이션·동심 감성파";
//     if (thriller >= 2) return "공포·스릴러 헌터";
//     if (drama >= 2) return "휴먼 드라마 Enthusiast";
//     if (crime >= 2) return "범죄·블랙미스터리 마니아";
//     if (sf >= 2) return "SF·우주 탐험가";
//     if (zombie >= 2) return "좀비·생존 액션러";
//
//     return "다양성 취향 균형형";
//   }
//
//   /// =========================================================
//   /// 6) 유형별 추천 영화
//   /// =========================================================
//   static Map<String, List<String>> recommendations = {
//     "감성 로맨스 Lover": ["라라랜드", "노팅힐", "비포 선라이즈"],
//     "액션·히어로 파워형": ["어벤져스: 엔드게임", "매드맥스: 분노의 도로", "다크 나이트"],
//     "애니메이션·동심 감성파": ["인사이드 아웃", "코코", "겨울왕국 2"],
//     "공포·스릴러 헌터": ["겟 아웃", "유전", "나이트크롤러"],
//     "휴먼 드라마 Enthusiast": ["포레스트 검프", "더 퍼스트 슬램덩크", "인생은 아름다워"],
//     "범죄·블랙미스터리 마니아": ["기생충", "나이브스 아웃", "세븐"],
//     "SF·우주 탐험가": ["인터스텔라", "그래비티", "매트릭스"],
//     "좀비·생존 액션러": ["부산행", "28일 후", "킹덤"],
//     "다양성 취향 균형형": ["기생충", "인사이드 아웃", "위플래시"],
//   };
//
//   /// =========================================================
//   /// 7) 🔥 유형별 키워드 (MovieTasteAnalysisScreen에서 사용)
//   /// =========================================================
//   static Map<String, List<String>> typeKeywords = {
//     "감성 로맨스 Lover": [
//       "감성 강한 타입",
//       "스토리 중요",
//       "연출·음악 중시",
//       "몰입형 관객",
//     ],
//     "액션·히어로 파워형": [
//       "스케일 중시",
//       "속도감 중요",
//       "히어로물 선호",
//       "타격감·쾌감형",
//     ],
//     "애니메이션·동심 감성파": [
//       "동심형 감성",
//       "비주얼 중시",
//       "따뜻한 관계",
//       "가볍고 편안함",
//     ],
//     "공포·스릴러 헌터": [
//       "긴장감 선호",
//       "반전·추리형",
//       "어두운 분위기",
//       "빠른 몰입",
//     ],
//     "휴먼 드라마 Enthusiast": [
//       "인물 중심",
//       "감정선 중요",
//       "잔잔한 여운",
//       "현실적 서사",
//     ],
//     "범죄·블랙미스터리 마니아": [
//       "사건 중심",
//       "심리묘사 선호",
//       "도덕적 모호성",
//       "미스터리 중시",
//     ],
//     "SF·우주 탐험가": [
//       "세계관 중시",
//       "철학적 질문",
//       "비주얼 임팩트",
//       "몰입감 높은 관객",
//     ],
//     "좀비·생존 액션러": [
//       "긴박함 선호",
//       "생존 서사",
//       "강한 몰입감",
//       "분위기·연출 중시",
//     ],
//     "다양성 취향 균형형": [
//       "장르 편식 없음",
//       "균형 잡힌 취향",
//       "새로운 것 선호",
//       "유연한 관객",
//     ],
//   };
// }